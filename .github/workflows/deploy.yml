name: Deploy to IPFS (Pinata)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build static export
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Upload to Pinata
        env:
          PINATA_KEY: ${{ secrets.PINATA_KEY }}
          PINATA_SECRET: ${{ secrets.PINATA_SECRET }}
        run: |
          pip install requests --quiet
          python3 << 'EOF'
          import os, requests, mimetypes
          from pathlib import Path

          key    = os.environ["PINATA_KEY"]
          secret = os.environ["PINATA_SECRET"]
          out_dir = Path("out")

          files = []
          for f in sorted(out_dir.rglob("*")):
              if f.is_file():
                  rel = str(f.relative_to(out_dir))
                  mime = mimetypes.guess_type(str(f))[0] or "application/octet-stream"
                  files.append(("file", (f"lyzerd/{rel}", open(f, "rb"), mime)))

          res = requests.post(
              "https://api.pinata.cloud/pinning/pinFileToIPFS",
              headers={
                  "pinata_api_key": key,
                  "pinata_secret_api_key": secret
              },
              files=files,
              data={
                  "pinataMetadata": '{"name":"lyzerd-frontend"}',
                  "pinataOptions": '{"cidVersion":1}'
              }
          )
          data = res.json()
          print("Response:", data)
          cid = data["IpfsHash"]
          print(f"CID: {cid}")
          print(f"URL: https://gateway.pinata.cloud/ipfs/{cid}")
          print(f"IPFS: https://{cid}.ipfs.dweb.link")
          EOF
