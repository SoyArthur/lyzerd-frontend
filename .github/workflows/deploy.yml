name: Deploy to IPFS (Pinata)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build static export
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Upload to Pinata via curl
        run: |
          cd out
          # Construir args de archivo para curl
          FILES=$(find . -type f | sort | sed 's|^\./||' | xargs -I{} echo "-F file=@\"{}\";filename=\"lyzerd/{}\""  | tr '\n' ' ')
          RESPONSE=$(eval curl -s -X POST \
            "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
            -F 'pinataOptions={"cidVersion":1}' \
            -F 'pinataMetadata={"name":"lyzerd-frontend"}' \
            $FILES)
          echo "Response: $RESPONSE"
          CID=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['IpfsHash'])")
          echo "‚úÖ CID: $CID"
          echo "üåê https://gateway.pinata.cloud/ipfs/$CID"
          echo "üåê https://$CID.ipfs.dweb.link"
